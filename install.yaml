# Details about the install.yaml file are at https://ddev.readthedocs.io/en/latest/users/extend/additional-services/#sections-and-features-of-ddev-get-add-on-installyaml

name: ddev-drupal-core-dev

project_files:
  - config.ddev-drupal-core-dev.yaml
  - docker-compose.core-dev-selenium.yaml
  - core-dev/phpunit-firefox.xml
  - core-dev/phpunit-chrome.xml
  - commands/web/drupal
  - commands/web/phpunit
  - commands/web/nightwatch
  - commands/web/install
  - commands/web/code-check
  - commands/web/cspell-check
  - commands/web/phpcbf
  - commands/web/phpcs
  - commands/web/phpstan
  - commands/web/tests-cleanup
  - core-dev/gitignore
  - core-dev/.env
  - core-dev/src/Command/AdminLoginCommand.php
  - core-dev/src/Command/BootCommand.php
  - core-dev/src/Command/CacheCommand.php
  - core-dev/src/Command/TestCommand.php
  - core-dev/src/Command/TestBrowserCommand.php
  - core-dev/src/Command/UninstallCommand.php
  - core-dev/src/Command/LintPhpCsCommand.php
  - core-dev/src/Command/LintPhpStanCommand.php
  - core-dev/src/Command/LintCssCommand.php
  - core-dev/src/Command/LintJsCommand.php
  - core-dev/src/Command/LintCspellCommand.php
  - core-dev/src/Command/LintCommand.php

post_install_actions:
  - mkdir -p ../repos
  - git clone --branch=11.x https://git.drupalcode.org/project/drupal.git ../repos/drupal
  - cp ../repos/drupal/core/phpunit.xml.dist ../phpunit.xml
  - sed -i '2s/^/#ddev-generated\n/' ../phpunit.xml
  - perl -pi -e "s|DRUPAL_CORE_DDEV_URL|$DDEV_PRIMARY_URL|g" ../phpunit.xml
  - perl -pi -e "'$DDEV_DOCROOT' and s|DDEV_DOCROOT|$DDEV_DOCROOT/|g" ../phpunit.xml
  - cp core-dev/.env ../.env
  - cp core-dev/gitignore ../.gitignore
  - mkdir -p ../test_output
  - chmod -R 777 ../test_output
  # - cd ../web/core && ddev yarn

removal_actions:
  - |
    for item in ../phpunit.xml ../.env ../.gitignore; do
      if grep '#ddev-generated' ${item} >/dev/null; then
        rm -f ${item}
      fi
    done
  - echo removing test_output directory
  - rm -rf ../test_output
